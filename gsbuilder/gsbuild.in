#Copyright 2002-2007 Barcelona Supercomputing Center (www.bsc.es)
#                                                                 
# Licensed under the Apache License, Version 2.0 (the "License"); 
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at                         
#                                                                 
#     http://www.apache.org/licenses/LICENSE-2.0                  
#                                                                 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,  
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and     
# limitations under the License.                                          

#!@BASH@

set -e

export PATH=$PATH:@ac_rtpath@

working_dir=`pwd`

function exittrap {
        rc=$?      
        if test x"$rc" != x"0" ; then
                echo "ERROR: Command exited with status" $rc"." 1>&2
                exit $rc                                            
        fi                                                          
}                                                                   

trap exittrap 0


# message functions
usage() {

        echo " "
        echo  Usage\: `basename $0` build \<component\> \<appname\> \<project_path\> \<resources_path\> \<historical_path\>
        echo  Usage\: `basename $0` copy   \<component\> \<appname\>
        echo  Usage\: `basename $0` clean \<component\> \<appname\>
        echo ""
        echo "  Available actions:"
        echo "    copy         Setup a compilation environment for the component for customization."
        echo "    build        Build the selected component ."
        echo "    clean        Remove generated binaries."
        echo ""
        echo "  Available components:"
        echo "    master       Build or copy the master part."
        echo "    worker       Build or copy the worker part."
        echo "    all          Build or copy the master and workers parts."
        echo ""
        echo "  <appname> Corresponds to the name of the application used for source files and IDL files."
        echo "  <projectpath> Corresponds to the path of the project description file."
        echo "  <resourcespath> Corresponds to the path of the resources description file."
        echo "  <historicalpath> Corresponds to the path of the historical description file."
        echo " "
        exit
}


error() {
        echo "An error occurred, please check the output."
        exit 1;                                           
}                                                   

source $GS_HOME/share/gridsuperscalar/build/scripts/build_worker_scripts.sh

# Generating autogen.sh script

generate_autogen_sh() {
worker=$1

@CAT@ > autogen.sh << EOF

#!@BASH@
set -e

export CC="@CC@"
export CXX="@CXX@"

@ACLOCAL@
@AUTOMAKE@ -a -c
@AUTOCONF@
EOF
if test x"$worker" != x"1" ; then
@CAT@ >> autogen.sh << EOF
        if( test x\$4 != x"" ); then
                 ./configure --with-gs-prefix=$GS_HOME --with-prj-file=\$1 --with-res-file=\$2 --with-hist-file=\$3 --with-master-dir=\$4
        else
                 ./configure --with-gs-prefix=$GS_HOME --with-prj-file=\$1 --with-res-file=\$2 --with-hist-file=\$3
        fi
EOF

else
@CAT@ >> autogen.sh << EOF
        ./configure --with-gs-prefix=$GS_HOME
EOF
fi

@CAT@ >> autogen.sh << EOF
for script in workerGS.sh workerGS_script.sh config_worker.sh config_master.sh config_all.sh ssh_execute.sh; do
        if ( test -e \$script && ! test -x \$script ); then
                @CHMOD@ +x \$script;
        fi
done
EOF
        @CHMOD@ +x autogen.sh
}

# master functions

prepare_master_copy() {
        gsprefix=$1    
        appname=$2     

        if test -d master ; then      
                cd master             
           if test -e $2.cc ; then    
                                      
             if test -e $2.idl ; then 
                echo "All files needed found."
                                              
             else                             
                echo "File $2.idl not found." 
                exit                          
             fi                               

           else
             echo "File $2.cc not found."
             exit                        
           fi                            

        else
                echo "The master directory must exist when using copy action."
                exit                                                          
        fi                                                                    
}                                                                             

prepare_master_build() {
        gsprefix=$1     
        appname=$2      

        if test -d master ; then
                echo "The master directory already exists from a previous build. Removing."
                @RM@ -rf master                                                         
        fi                                                                                 

        @MKDIR@ master
        @CP@ *.* master
        cd master 
	@RM@ $2-functions.c                                                                                                

        @MKDIR@ gsbuild
        cd gsbuild        

        @LN_S@ -f ../*.c .
        @LN_S@ -f ../*.cc .
        @LN_S@ -f ../*.cpp .
        @LN_S@ -f ../*.cxx .
        @LN_S@ -f ../*.idl .
        @LN_S@ -f ../*.h .  
        @LN_S@ -f @prefix@/etc/gss-master-env.sh .
        @LN_S@ -f @prefix@/etc/gss-master-env.csh .
}                                                  

copy_master_build_env() {
        gsprefix=$1      
        appname=$2       

        @CP@ @prefix@/share/gridsuperscalar/build/c/master/Makefile.am Makefile.am.source
        @CAT@ @prefix@/share/gridsuperscalar/build/c/master/configure.in | @SED@ -e s/PACKAGE/"$appname"/g | @SED@ -e s/CLASSADS_SUPPORT/"@with_classads@"/g | @SED@ -e s/execution_env/"@exec_environment@"/g > configure.in                                                                                             
        @CAT@ Makefile.am.source | @SED@ 's/PACKAGE/'$appname'/g' > Makefile.am


	#Machine Arch Calculation

        machine_arch=$(uname -p | /usr/bin/cut -c 1);

        if [ $machine_arch == 'i' ]; then

            arch="i386"
            subfolder="client"
        else                  
            arch="ppc"        
            subfolder="classic"
        fi                     

        @CP@ Makefile.am Makefile.am.source
        @CAT@ Makefile.am.source | @SED@ s/ARCH/$arch/g | @SED@ s/SUBFLDR/$subfolder/g > Makefile.am
                                                                            
        generate_autogen_sh 0                                                                                                                                
        @TOUCH@ NEWS README AUTHORS ChangeLog                                                                                                                
        echo "" > empty.cc                                                                                                                                   

        path_to_dist="@prefix@";
        path_to_dist=$(echo $path_to_dist | @SED@ 's/\//\\\//g')
        copy_comm="@copy_command@";                             
        copy_comm=$(echo $copy_comm | @SED@ 's/\//\\\//g');     
        copy_comm_flags="@copy_command_flags@";                 
        copy_comm_flags=$(echo $copy_comm_flags | @SED@ 's/\//\\\//g');

        @CAT@ @prefix@/share/gridsuperscalar/build/scripts/config_script.sh.in | @SED@ 's/PACKAGE/'$path_to_dist'/g' |
        @SED@ -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |                                          
        @SED@ -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_master.sh.in;                                 
}                                                                                                                     

build_master() {
        gsprefix=$1
        appname=$2
        project_file_path=$3
        resources_file_path=$4
        historical_file_path=$5
        if [ -z "$project_file_path" ]
        then
                project_file_path="${working_dir}/project.xml"
        fi
        if [ -z "$resources_file_path" ]
        then
                resources_file_path="${working_dir}/resources.xml"
        fi
        if [ -z "$historical_file_path" ]
        then
                historical_file_path="${working_dir}/historical.xml"
        fi
        echo "Running Autogen with: "
        echo "Project File: $project_file_path "
        echo "Resources File: $resources_file_path "
        echo "Historical File: $historical_file_path"
        ./autogen.sh $project_file_path $resources_file_path $historical_file_path       
        @MAKE@                
}                   

finish_master_build() {
	gsprefix=$1    
        appname=$2     
        @CP@ -f $appname ..
        @CP@ -f config_master.sh ..
        cd ..            
	@CP@ gsbuild/*-constraints .
        @RM@ -rf gsbuild/*
        @MV@ *-constraints gsbuild
        @RM@ -f config_master.sh.in
        cd ..          
}                                  

clean_master() {         
        if test -d master ; then
           cd master            
           @RM@ -f $appname gss-master-env.sh gss-master-env.csh config_master.sh 
           cd ..                                                   
        else                                                       
           echo "The master directory must exist when using clean action."
           exit                                                           
        fi                           
}                                                                    


# worker functions
prepare_worker_copy() {
        gsprefix=$1    
        appname=$2     

        if test -d worker ; then
                cd worker       
           if test -e $2-functions.c ; then
                                           
             if test -e $2.idl ; then      
                echo "All files needed found."

             else
                echo "File $2.idl not found."
                exit                         
             fi                              

           else
             echo "File $2-functions.c not found."
             exit                                 
           fi                                     

        else
                echo "The worker directory must exist when using copy action."
                exit                                                          
        fi                                                                    
}                                                   

prepare_worker_build() {
	gsprefix=$1     
        appname=$2      


        if test -d worker ; then
                echo "The worker directory already exists from a previous build. Removing."
                @RM@ -rf worker                                                         
        fi                                                                                 

        @MKDIR@ worker
        @CP@ *.* worker
        cd worker
	@RM@ $2.cc                           
        @MKDIR@ files                    
                                                                              
        @MKDIR@ gsbuild
        cd gsbuild        

        @LN_S@ -f ../*.c .
        @LN_S@ -f ../*.cc .
        @LN_S@ -f ../*.cpp .
        @LN_S@ -f ../*.cxx .
        @LN_S@ -f ../*.idl .
        @LN_S@ -f ../*.h .  
        @LN_S@ -f ../workerGS_script.sh.in .
        @LN_S@ -f ../workerGS.sh.in .       
        @LN_S@ -f ../config_worker.sh.in .    
}                                           

copy_worker_build_env() {
        gsprefix=$1      
        appname=$2       

        @CP@ @prefix@/share/gridsuperscalar/build/c/worker/Makefile.am Makefile.am.source
        @CAT@ @prefix@/share/gridsuperscalar/build/c/worker/configure.in | @SED@ -e s/PACKAGE/"$appname"/g | @SED@ -e s/execution_env/"@exec_environment@"/g > configure.in                                                                                                                                               
        @CAT@ Makefile.am.source | @SED@ 's/PACKAGE/'$appname'/g'| @SED@ -e s/execution_env/"@exec_environment@"/g > Makefile.am                             
        generate_autogen_sh 1                                                                                                                                
        @TOUCH@ NEWS README AUTHORS ChangeLog                                                                                                                

        path_to_dist="@prefix@";
        path_to_dist=$(echo $path_to_dist | @SED@ 's/\//\\\//g')
        copy_comm="@copy_command@";                             
        copy_comm=$(echo $copy_comm | @SED@ 's/\//\\\//g');     
        copy_comm_flags="@copy_command_flags@";                 
        copy_comm_flags=$(echo $copy_comm_flags | @SED@ 's/\//\\\//g');

        @CAT@ @prefix@/share/gridsuperscalar/build/scripts/config_script.sh.in | @SED@ 's/PACKAGE/'$path_to_dist'/g' |
                @SED@ -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |                                          
                @SED@ -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_worker.sh.in;                                 

        generate_workergs_script_sh_in
        if [ x"@exec_environment@" == x"MN_SCRATCH" ]; then
                if ! test x"@QUEUE_SUBMIT_MN@" = x"none" ; then
                        generate_workergs_sh_MN "@QUEUE_SUBMIT_MN@"
                else                                               
                        generate_workergs_sh_MN "@QUEUE_SUBMIT_LL@"
                fi                                                 
        else                                                       
                if ! test x"@QUEUE_SUBMIT_PBS@" = x"none" ; then   
                        generate_workergs_sh_MN "@QUEUE_SUBMIT_PBS@"
                else                                                
                        generate_workergs_sh_MN "@QUEUE_SUBMIT_LL@" 
                fi                                                  
        fi                                                          

        @LN_S@ -f ${appname}-worker workerGS

	#Generating clean script
        echo '#!/bin/sh' >> clean.sh
        echo >> clean.sh
        echo 'rm -rf $1/*.IT' >> clean.sh
        @CHMOD@ +x clean.sh

}                                           

build_worker() {
	gsprefix=$1
        appname=$2 
        echo "Running Autogen... "
        ./autogen.sh              
        @MAKE@                
}                   

finish_worker_build() {
        gsprefix=$1    
        appname=$2     
        @CP@ -f $appname-worker ..
        @CP@ -f config_worker.sh ..
        @CP@ -f workerGS.sh ..     
        @CP@ -f workerGS_script.sh ..
	@CP@ -f clean.sh ..

        cd ..
        @RM@ -rf gsbuild
        @RM@ -f config_worker.sh.in
        @RM@ -f workerGS_script.sh.in
        @RM@ -f workerGS.sh.in       

        @LN_S@ -f ${appname}-worker workerGS
}                                           

clean_worker() {
 
        if test -d worker ; then
           cd worker            
           @RM@ -f ${appname}-worker workerGS workerGS.sh workerGS_script.sh clean.sh config_worker.sh 
           cd ..                                                      
        else                                                          
           echo "The worker directory must exist when using clean action."
           exit                                                           
        fi                                   
}    
                                                          
# main code
if test $# != 3 ; then
   if test $# != 5; then
        usage           
   fi                   
fi                        

action=$1
component=$2
appname=$3
project_file_path=$4
resources_file_path=$5
historical_file_path=$6 

if test x"$GS_LOCATION" != x ; then
        echo "Using environment variable GS_LOCATION."
        gsprefix=$GS_LOCATION                         
else                                                  
        gsprefix=@prefix@                             
fi                                                    


case $action in
        copy)  
                case $component in
                        master)   
                                echo "Preparing master build environment..."
                                prepare_master_copy $gsprefix $appname      
                                copy_master_build_env $gsprefix $appname    
                                ;;                                          
                        worker)                                             
                                echo "Preparing worker build environment..."
                                prepare_worker_copy $gsprefix $appname      
                                copy_worker_build_env $gsprefix $appname    
                                ;;                                          
                        all)                                                
                                echo "Preparing master and worker build environment:"
                                echo " "                                             

                                echo "Preparing master build environment..."
                                prepare_master_copy $gsprefix $appname      
                                copy_master_build_env $gsprefix $appname    
                                cd ..                                       

                                echo " "
                                echo "Preparing worker build environment..."
                                prepare_worker_copy $gsprefix $appname      
                                copy_worker_build_env $gsprefix $appname    
                                ;;                                    
                        *)                                            
                                usage                                 
                                ;;                                    
                esac                                                  
                ;;                                                    
        build)                                                        
                case $component in                                    
                        master)                                       
                                echo "Building master"                
                                prepare_master_build $gsprefix $appname
                                copy_master_build_env $gsprefix $appname
                                build_master $gsprefix $appname $project_file_path $resources_file_path $historical_file_path
                                finish_master_build $gsprefix $appname                                 
                                ;;                                                                     
                        worker)                                                                        
                                echo "Building worker"                                                 
                                prepare_worker_build $gsprefix $appname                                
                                copy_worker_build_env $gsprefix $appname                               
                                build_worker $gsprefix $appname
                                finish_worker_build $gsprefix $appname
                                ;;
                        all)
                                echo "Building all:"
                                echo " "
                                echo "Building Master..."

                                prepare_master_build $gsprefix $appname
                                copy_master_build_env $gsprefix $appname
                                build_master $gsprefix $appname $project_file_path $resources_file_path $historical_file_path
                                finish_master_build $gsprefix $appname

                                echo " "
                                echo "Building Worker..."

                                prepare_worker_build $gsprefix $appname
                                copy_worker_build_env $gsprefix $appname
                                build_worker $gsprefix $appname
                                finish_worker_build $gsprefix $appname
                                ;;
                        *)
                                usage
                                ;;
                esac
                ;;
        clean)
                case $component in
                        master)
                                echo "Cleaning master"
                                clean_master
                                ;;
                        worker)
                                echo "Cleaning worker"
                                clean_worker
                                ;;
                        all)
                                echo "Cleaning master and worker"
                                clean_master
                                clean_worker
                                ;;
                        *)
                                usage
                                ;;
                esac
                ;;
        *)
                usage
                ;;
esac

echo "Command succesful."

