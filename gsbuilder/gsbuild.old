# Copyright 2002-2007 Barcelona Supercomputing Center (www.bsc.es)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#!/bin/sh

set -e

export PATH=$PATH:/usr/bin:/usr/i586-suse-linux/bin:

function exittrap {
	rc=$?
	if test x"$rc" != x"0" ; then
		echo "ERROR: Command exited with status" $rc"." 1>&2
		exit $rc
	fi
}

trap exittrap 0


# message functions
usage() {

	echo  Usage\: `basename $0` \<action\> \<component\> \<appname\>
	echo ""
	echo "  Available actions:"
	echo "    copy         Setup a compilation environment for the component for customization."
	echo "    build        Build the selected component ."
	echo "    clean        Remove generated binaries."
	echo ""
	echo "  Available components:"
	echo "    master       Build or copy the master part."
	echo "    worker       Build or copy the worker part."
	echo "    all          Build or copy the master and workers parts."
	echo ""
	echo "  <appname> corresponds to the name of the application used for source files and IDL files."
	exit 1
}


error() {
	echo "An error occurred, please check the output."
	exit 1;
}

source $GS_HOME/share/gridsuperscalar/build/scripts/build_worker_scripts.sh


generate_autogen_sh() {
worker=$1
	/bin/cat > autogen.sh << EOF
#!/bin/sh
set -e

export CC="gcc"
export CXX="g++"

/usr/bin/aclocal
/usr/bin/automake -a -c
/usr/bin/autoconf
EOF
if test x"$worker" != x"1" ; then
/bin/cat >> autogen.sh << EOF
	if( test x\$3 != x"" ); then
		 ./configure --with-gs-prefix=$GS_HOME --with-prj-file=\$1 --with-res-file=\$2 --with-master-dir=\$3
	else
		 ./configure --with-gs-prefix=$GS_HOME --with-prj-file=\$1 --with-res-file=\$2
	fi
EOF
else
/bin/cat >> autogen.sh << EOF
	./configure --with-gs-prefix=$GS_HOME
EOF
fi

/bin/cat >> autogen.sh << EOF
for script in workerGS.sh workerGS_script.sh config_worker.sh config_master.sh config_all.sh ssh_execute.sh; do
        if ( test -e \$script && ! test -x \$script ); then
                /bin/chmod +x \$script;
        fi
done
EOF
	/bin/chmod +x autogen.sh
}


# master functions
prepare_master_build() {
	gsprefix=$1
	appname=$2
	if test -d gsbuild ; then
		echo "The gsbuild directory already exists from a previous build. Removing."
		/bin/rm -rf gsbuild
	fi
	
	/bin/mkdir gsbuild
	cd gsbuild
	ln -s -f ../*.c .
	ln -s -f ../*.cc .
	ln -s -f ../*.cpp .
	ln -s -f ../*.cxx .
	ln -s -f ../*.idl .
	ln -s -f ../*.h .
	ln -s -f /home/rrafanel/COMPSs//etc/gss-master-env.sh .
	ln -s -f /home/rrafanel/COMPSs//etc/gss-master-env.csh .
}

copy_master_build_env() {
	gsprefix=$1
	appname=$2

	/bin/cp /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/master/Makefile.am Makefile.am.source
	/bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/master/configure.in | /usr/bin/sed -e s/PACKAGE/"$appname"/g | /usr/bin/sed -e s/CLASSADS_SUPPORT/"no"/g | /usr/bin/sed -e s/execution_env/"GRID"/g > configure.in 
	/bin/cat Makefile.am.source | /usr/bin/sed 's/PACKAGE/'$appname'/g' > Makefile.am

	#Machine Arch Calculation

	machine_arch=$(uname -p | /usr/bin/cut -c 1);

	if [ $machine_arch == 'i' ]; then

       	    arch="i386"
            subfolder="client"
        else
            arch="ppc"
            subfolder="classic"
        fi
	
	/bin/cp Makefile.am Makefile.am.source
        /bin/cat Makefile.am.source | /usr/bin/sed s/ARCH/$arch/g | /usr/bin/sed s/SUBFLDR/$subfolder/g > Makefile.am

	generate_autogen_sh 0 
	/usr/bin/touch NEWS README AUTHORS ChangeLog
	echo "" > empty.cc

	path_to_dist="/home/rrafanel/COMPSs/";
        path_to_dist=$(echo $path_to_dist | /usr/bin/sed 's/\//\\\//g')
	copy_comm="@SCP@";
	copy_comm=$(echo $copy_comm | /usr/bin/sed 's/\//\\\//g');
	copy_comm_flags="-q -o StrictHostKeyChecking=no";
	copy_comm_flags=$(echo $copy_comm_flags | /usr/bin/sed 's/\//\\\//g');

	/bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/scripts/config_script.sh.in | /usr/bin/sed 's/PACKAGE/'$path_to_dist'/g' |
		/usr/bin/sed -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |
		/usr/bin/sed -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_master.sh.in;
}

build_master() {
	gsprefix=$1
	appname=$2
	./autogen.sh
	/usr/bin/make
}

finish_master_build() {
	gsprefix=$1
	appname=$2
	/bin/cp -f $appname ..
	/bin/cp -f config_master.sh ..
	cd ..
	/bin/rm -rf gsbuild
	/bin/rm -f config_master.sh.in
}

clean_master() {
	/bin/rm -f $appname gss-master-env.sh gss-master-env.csh || exit
}
build_all_script(){
	gsprefix=$1
        appname=$2
	
	if test -d gsbuild ; then
                echo "The gsbuild directory already exists from a previous build. Removing."
                /bin/rm -rf gsbuild
        fi

        /bin/mkdir gsbuild
        cd gsbuild

	/bin/cp /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/all/Makefile.am Makefile.am.source
	/bin/cat Makefile.am.source | /usr/bin/sed 's/PACKAGE/'$appname'/g' > Makefile.am
        /bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/all/configure.in | /usr/bin/sed -e s/PACKAGE/"$appname"/g |
                                                                        /usr/bin/sed -e s/CLASSADS_SUPPORT/"no"/g |
									/usr/bin/sed -e s/execution_env/"GRID"/g > configure.in
        #/bin/cat Makefile.am.source | /usr/bin/sed 's/PACKAGE/'$appname'/g' > Makefile.am
        #generate_autogen_sh
        /usr/bin/touch NEWS README AUTHORS ChangeLog
        echo "" > empty.cc

        path_to_dist="/home/rrafanel/COMPSs/";
        path_to_dist=$(echo $path_to_dist | /usr/bin/sed 's/\//\\\//g')
        copy_comm="@SCP@";
        copy_comm=$(echo $copy_comm | /usr/bin/sed 's/\//\\\//g');
        copy_comm_flags="-q -o StrictHostKeyChecking=no";
        copy_comm_flags=$(echo $copy_comm_flags | /usr/bin/sed 's/\//\\\//g');

        /bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/scripts/config_script.sh.in | /usr/bin/sed 's/PACKAGE/'$path_to_dist'/g' |
                /usr/bin/sed -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |
                /usr/bin/sed -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_all.sh.in;
	set -e

	export CC="gcc"
	export CXX="g++"
	echo "Autogen..";
	/usr/bin/aclocal
	/usr/bin/automake -c -a
	/usr/bin/autoconf
	./configure 
	echo "Changing permisions...";
        /bin/chmod +x config_all.sh
	/bin/cp -f config_all.sh ..
        cd ..
        /bin/rm -rf gsbuild
        /bin/rm -f config_all.sh.in
}

# worker functions
prepare_worker_build() {
	gsprefix=$1
	appname=$2
	if test -d gsbuild ; then
		echo "The gsbuild directory already exists from a previous build. Removing."
		/bin/rm -rf gsbuild
	fi
	
	/bin/mkdir gsbuild
	cd gsbuild
	ln -s -f ../*.c .
	ln -s -f ../*.cc .
	ln -s -f ../*.cpp .
	ln -s -f ../*.cxx .
	ln -s -f ../*.idl .
	ln -s -f ../*.h .
	ln -s -f ../workerGS_script.sh.in .
	ln -s -f ../workerGS.sh.in .
	ln -s -f ../config_worker.sh.in .
}

copy_worker_build_env() {
	gsprefix=$1
	appname=$2

	/bin/cp /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/worker/Makefile.am Makefile.am.source
	/bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/worker/configure.in | /usr/bin/sed -e s/PACKAGE/"$appname"/g | /usr/bin/sed -e s/execution_env/"GRID"/g > configure.in
	/bin/cat Makefile.am.source | /usr/bin/sed 's/PACKAGE/'$appname'/g'| /usr/bin/sed -e s/execution_env/"GRID"/g > Makefile.am
	generate_autogen_sh 1
	/usr/bin/touch NEWS README AUTHORS ChangeLog

	path_to_dist="/home/rrafanel/COMPSs/";
        path_to_dist=$(echo $path_to_dist | /usr/bin/sed 's/\//\\\//g')
	copy_comm="@SCP@";
	copy_comm=$(echo $copy_comm | /usr/bin/sed 's/\//\\\//g');
	copy_comm_flags="-q -o StrictHostKeyChecking=no";
	copy_comm_flags=$(echo $copy_comm_flags | /usr/bin/sed 's/\//\\\//g');

	/bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/scripts/config_script.sh.in | /usr/bin/sed 's/PACKAGE/'$path_to_dist'/g' |
		/usr/bin/sed -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |
		/usr/bin/sed -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_worker.sh.in;

       	generate_workergs_script_sh_in
	if [ x"GRID" == x"MN_SCRATCH" ]; then
		if ! test x"none" = x"none" ; then
			generate_workergs_sh_MN "none"
		else
			generate_workergs_sh_MN "none"
		fi
	else 
		if ! test x"none" = x"none" ; then
			generate_workergs_sh_MN "none"
		else
			generate_workergs_sh_MN "none"
		fi
	fi

	ln -s -f ${appname}-worker workerGS
}

build_worker() {
	gsprefix=$1
	appname=$2
	./autogen.sh
	/usr/bin/make
}

finish_worker_build() {
	gsprefix=$1
	appname=$2
	/bin/cp -f $appname-worker ..
	/bin/cp -f config_worker.sh ..
	/bin/cp -f workerGS.sh ..	
	/bin/cp -f workerGS_script.sh ..	
	
	cd ..
	/bin/rm -rf gsbuild
	/bin/rm -f config_worker.sh.in
	/bin/rm -f workerGS_script.sh.in
	/bin/rm -f workerGS.sh.in

	ln -s -f ${appname}-worker workerGS
}

clean_worker() {
	/bin/rm -f ${appname}-worker workerGS.sh workerGS_script.sh
}
# all functions
prepare_all_build() {
        gsprefix=$1
        appname=$2
        if test -d gsbuild ; then
                echo "The gsbuild directory already exists from a previous build. Removing."
                /bin/rm -rf gsbuild
        fi

        /bin/mkdir gsbuild
        cd gsbuild
        ln -s -f ../*.c .
        ln -s -f ../*.cc .
        ln -s -f ../*.cpp .
        ln -s -f ../*.cxx .
        ln -s -f ../*.idl .
        ln -s -f ../*.h .
        ln -s -f ../workerGS_script.sh.in .
        ln -s -f ../workerGS.sh.in .
        ln -s -f ../config_worker.sh.in .
	ln -s -f ../config_all.sh.in .
	ln -s -f ../config_master.sh.in .
	ln -s -f /home/rrafanel/COMPSs//etc/gss-master-env.sh .
        ln -s -f /home/rrafanel/COMPSs//etc/gss-master-env.csh .
}

copy_all_build_env() {
        gsprefix=$1
        appname=$2

        /bin/cp /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/all/Makefile.am Makefile.am.source
        /bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/c/all/configure.in | /usr/bin/sed -e s/PACKAGE/"$appname"/g | /usr/bin/sed -e s/CLASSADS_SUPPORT/"no"/g | /usr/bin/sed -e s/execution_env/"GRID"/g > configure.in
	/bin/cat Makefile.am.source | /usr/bin/sed 's/PACKAGE/'$appname'/g' > Makefile.am
        generate_autogen_sh
        /usr/bin/touch NEWS README AUTHORS ChangeLog
	echo "" > empty.cc
        path_to_dist="/home/rrafanel/COMPSs/";
        path_to_dist=$(echo $path_to_dist | /usr/bin/sed 's/\//\\\//g')
        copy_comm="@SCP@";
        copy_comm=$(echo $copy_comm | /usr/bin/sed 's/\//\\\//g');
        copy_comm_flags="-q -o StrictHostKeyChecking=no";
        copy_comm_flags=$(echo $copy_comm_flags | /usr/bin/sed 's/\//\\\//g');

	/bin/cat /home/rrafanel/COMPSs//share/gridsuperscalar/build/scripts/config_script.sh.in | /usr/bin/sed 's/PACKAGE/'$path_to_dist'/g' |
                /usr/bin/sed -e s/_REMOTE_COPY_COMMAND_FLAGS_/"$copy_comm_flags"/ |
                /usr/bin/sed -e s/_REMOTE_COPY_COMMAND_/"$copy_comm"/ > config_all.sh.in;
        
	generate_workergs_script_sh_in
        
	if [ x"GRID" == x"MN_SCRATCH" ]; then
                if ! test x"none" = x"none" ; then
                        generate_workergs_sh_MN "none"
                else
                        generate_workergs_sh_MN "none"
                fi
        else
                if ! test x"none" = x"none" ; then
                        generate_workergs_sh_MN "none"
                else
                        generate_workergs_sh_MN "none"
                fi
        fi

        ln -s -f ${appname}-worker workerGS
}

build_all() {
        gsprefix=$1
        appname=$2
        ./autogen.sh
        /usr/bin/make
}

finish_all_build() {
        gsprefix=$1
        appname=$2
	/bin/cp -f $appname ..
        /bin/cp -f $appname-worker ..
	/bin/cp -f config_all.sh ..
        /bin/cp -f workerGS.sh ..
        /bin/cp -f workerGS_script.sh ..

        cd ..
        /bin/rm -rf gsbuild
	/bin/rm -f config_all.sh.in
        /bin/rm -f workerGS_script.sh.in
        /bin/rm -f workerGS.sh.in

        ln -s -f ${appname}-worker workerGS
}

clean_all() {
        /bin/rm -f ${appname}-worker workerGS.sh workerGS_script.sh workerGS config_all.sh
	/bin/rm -f $appname gss-master-env.sh gss-master-env.csh config_all.sh || exit
}

# main code
if test $# != 3 ; then
	usage
fi

action=$1
component=$2
appname=$3

if test x"$GS_LOCATION" != x ; then
	echo "Using environment variable GS_LOCATION."
	gsprefix=$GS_LOCATION
else
	gsprefix=/home/rrafanel/COMPSs/
fi


case $action in
	copy)
		case $component in
			master)
				echo "Preparing master build environment"
				copy_master_build_env $gsprefix $appname
				;;
			worker)
				echo "Preparing worker build environment"
				copy_worker_build_env $gsprefix $appname
				;;
			all)
				echo "Preparing master and worker build environment"
				copy_all_build_env $gsprefix $appname
				;;
			*)
				usage
				;;
		esac
		;;
	build)
		case $component in
			master)
				echo "Building master"
				prepare_master_build $gsprefix $appname
				copy_master_build_env $gsprefix $appname
				build_master $gsprefix $appname
				finish_master_build $gsprefix $appname
				;;
			worker)
				echo "Building worker"
				prepare_worker_build $gsprefix $appname
				copy_worker_build_env $gsprefix $appname
				build_worker $gsprefix $appname
				finish_worker_build $gsprefix $appname
				;;
			all)
				echo "Building all"
				prepare_all_build $gsprefix $appname
				copy_all_build_env $gsprefix $appname
				build_all $gsprefix $appname
				finish_all_build $gsprefix $appname
				;;
			*)
				usage
				;;
		esac
		;;
	clean)
		case $component in
			master)
				echo "Cleaning master"
				clean_master
				;;
			worker)
				echo "Cleaning worker"
				clean_worker
				;;
			all)
				echo "Cleaning master and worker"
				clean_all
				;;
			*)
				usage
				;;
		esac
		;;
	*)
		usage
		;;
esac

echo "Command succesful."

